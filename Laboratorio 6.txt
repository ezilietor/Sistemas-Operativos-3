Comandos usados practica 1

============================================
Simétrico
Gpg2 -c archivo.txt | Cifrar un archivo
Gpg2 -d archivo.txt.gpg > archivodescrifrado.txt | Descifrar un archivo
Asimétrico
Gpg2 --full-generate-key  	| Crear llave
Gpg2 -e -r (usuario) archivo.txt  | Cifrar el archivo
Gpg2 -d archivo.txt.gpt > archivodescrifrado.txt | Descifrarlo.

Comandos usados practica 2

============================================
sudo dnf install httpd vsftpd openssh-server -y | Instala los servicios que usan el puerto 80,22,21

sudo systemctl enable --now httpd | habilitar http
sudo systemctl enable --now vsftpd | Habilitar
vsftpdsudo systemctl enable --now sshd | habilitar ssh


sudo firewall-cmd --permanent --add-service=http | habilitar http en firewall
sudo firewall-cmd --permanent --add-service=ftp | Habilitar ftp en firewall
sudo firewall-cmd --permanent --add-service=ssh | habilitar ssh en firewall
sudo firewall-cmd --reload

curl localhost | Probar acceso de http
ftp localhost | Probar acceso de vsftp
ssh localhost 	| probar acceso de ssh

sudo iptables -A INPUT -p tcp --dport 80 -j DROP | Bloquea el puerto 80 con iptables
sudo iptables -D INPUT -p tcp --dport 80 -j DROP | Habilitar el puerto 80 con iptables
sudo iptables -A INPUT -p tcp --dport 22 -j DROP | Bloquea el puerto 22 con iptables
sudo iptables -D INPUT -p tcp --dport 22 -j DROP | Habilitar el puerto 22 con iptables
sudo iptables -A INPUT -p tcp --dport 21 -j DROP | Bloquea el puerto 21 con iptables
sudo iptables -D INPUT -p tcp --dport 21 -j DROP | Habilitar el puerto 21 con iptables

sudo firewall-cmd --permanent --add-port=80/tcp | Habilitar puerto 80
sudo firewall-cmd --permanent --add-port=22/tcp | Habilitar puerto 22
sudo firewall-cmd --permanent --add-port=21/tcp | Habilitar puerto 21
sudo firewall-cmd --reload
sudo firewall-cmd --permanent --remove-port=80/tcp | Deshabilitar puerto 80
sudo firewall-cmd --permanent --remove-port=22/tcp | Deshabilitar puerto 22
sudo firewall-cmd --permanent --remove-port=21/tcp | Deshabilitar puerto 21
sudo firewall-cmd --reload
Ojo hay que deshabilitar tanto el puerto como el servicio para que deje de correr.
sudo firewall-cmd --permanent --remove-service=ssh | Quitar el servicio de ssh del Firewall
sudo firewall-cmd --permanent --remove-service=ftp | Quitar el servicio de ftp del Firewal
sudo firewall-cmd --permanent --remove-service=http | Quitar el servicio de http del Firewal


Comandos usados practica 3

============================================

INSTALACIÓN DE IDS SNORT


#. Actualizar
sudo dnf update -y
sudo dnf install -y epel-release
sudo dnf config-manager --set-enabled crb
sudo dnf update -y

#. Instalar dependencias esenciales.
sudo dnf groupinstall -y "Development Tools"
sudo dnf install -y \
 flex bison gcc gcc-c++ make cmake cmake3 autoconf libtool git wget unzip nano \
 libpcap libpcap-devel pcre2 pcre2-devel luajit luajit-devel \
 openssl openssl-devel zlib zlib-devel hwloc hwloc-devel \
 pkgconfig pkgconf libunwind libunwind-devel libmnl libmnl-devel \
 libnetfilter_queue libnetfilter_queue-devel gperftools gperftools-devel \
 uuid-devel xz-devel numactl numactl-devel hyperscan hyperscan-devel || true

#. por Hyperscan (solo si no funciona OJO)

sudo dnf install -y gperftools gperftools-devel
sudo dnf install -y pcre2 pcre2-devel
sudo dnf install -y libpcap libpcap-devel
sudo dnf install -y luajit luajit-devel
sudo dnf install -y hwloc hwloc-devel
sudo dnf install -y boost boost-devel
sudo dnf install -y cmake gcc-c++ make

cd /usr/local/src
sudo wget https://www.colm.net/files/ragel/ragel-6.10.tar.gz
sudo tar -xzf ragel-6.10.tar.gz
cd ragel-6.10
sudo ./configure
sudo make -j$(nproc)
sudo make install
ragel --version

sudo tee /etc/profile.d/localbin.sh > /dev/null <<'EOF'
export PATH=/usr/local/bin:$PATH
EOF
sudo chmod 644 /etc/profile.d/localbin.sh
source /etc/profile

cd /usr/local/src
sudo git clone https://github.com/intel/hyperscan.git
cd hyperscan
sudo mkdir build && cd build
sudo cmake3 -DCMAKE_INSTALL_PREFIX=/usr/local -DBUILD_STATIC_AND_SHARED=1 ..
sudo make -j$(nproc)
sudo make install
sudo ldconfig

#. Compilar libdnet
cd /home/Server
git clone https://github.com/dugsong/libdnet.git
cd libdnet
./configure --without-check
make -j$(nproc)
sudo make install
sudo ldconfig
cd ..

# Compiar lidaq
cd /home/fred
git clone https://github.com/snort3/libdaq.git
cd libdaq
./bootstrap
./configure
make -j$(nproc)
sudo make install
sudo ldconfig
cd ..

# Variables

export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:/usr/local/lib64/pkgconfig:$PKG_CONFIG_PATH
export CFLAGS="-O3"
export CXXFLAGS="-O3 -fno-rtti"

# Compilar Snort3
cd /home/fred
git clone https://github.com/snort3/snort3.git
cd snort3
./configure_cmake.sh --prefix=/usr/local/snort --enable-tcmalloc
cd build
make -j$(nproc)
sudo make install
sudo ldconfig
cd ../..

# Verificación de Instalacion
sudo ln -sf /usr/local/snort/bin/snort /usr/bin/snort
snort -V

# Configurar LUA
sudo cp /usr/local/snort/etc/snort/snort.lua /usr/local/snort/etc/snort/snort.lua.bak
sudo nano /usr/local/snort/etc/snort/snort.lua

HOME_NET = '10.0.0.17/24'

--------SI DAQ TE DA PROBLEMAS----------------------
cd /usr/local/src
sudo rm -rf libdaq         
sudo git clone https://github.com/snort3/libdaq.git
cd libdaq
sudo ./bootstrap
sudo ./configure --enable-static --enable-shared
sudo make -j$(nproc)
sudo make install
sudo ldconfig

snort --daq-list


snort -T -c /usr/local/snort/etc/snort/snort.lua
SINOFUNCIONA USA snort -c /usr/local/snort/etc/snort/snort.lua --daq afpacket -T


# Crear reglas y directorios
sudo mkdir -p /usr/local/snort/etc/snort/rules /var/log/snort
sudo chown -R fred:fred /usr/local/snort/etc/snort /var/log/snort
sudo chmod -R 750 /usr/local/snort/etc/snort /var/log/snort

# Crear reglas locales
sudo nano /usr/local/snort/etc/snort/local.rules

# Detectar tráfico ICMP (ping)
alert icmp any any -> 10.0.0.17 any (msg:"ALERT ICMP to monitored host"; sid:1000001; rev:1;)

# Detectar tráfico TCP hacia 21 (FTP)
alert tcp any any -> 10.0.0.17 21 (msg:"ALERT TCP to port 21 (FTP)"; sid:1000002; rev:1;)

# Detectar tráfico TCP hacia 22 (SSH)
alert tcp any any -> 10.0.0.17 22 (msg:"ALERT TCP to port 22 (SSH)"; sid:1000003; rev:1;)

# Detectar tráfico TCP hacia 80 (HTTP)
alert tcp any any -> 10.0.0.17 80 (msg:"ALERT TCP to port 80 (HTTP)"; sid:1000004; rev:1;)

# Modo Promisc
sudo ip link set dev ens33 promisc on
ip -d link show ens33

#Ejecutar Snort
sudo snort -c /usr/local/snort/etc/snort/snort.lua \
 -R /usr/local/snort/etc/snort/local.rules \
 -i ens33 -A console -s 65535 -k none -q

XXSI NO TE FUNCIONA PRUEBA XXXXX
sudo snort -c /usr/local/snort/etc/snort/snort.lua \
  --daq afpacket \
  -R /usr/local/snort/etc/snort/local.rules \
  -i ens33 \
  -A fast \
  -s 65535 \
  -k none

#En caso que no funcione sytem
sudo tee /etc/systemd/system/snort.service <<'EOF'
[Unit]
Description=Snort IDS
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/snort -c /usr/local/snort/etc/snort/snort.lua -i ens33 -A alert_fast -s 65535 -k none
Restart=on-failure
User=fred
Group=fred

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable --now snort
sudo journalctl -u snort -f

# Prueba el trafico
ping -c 4 192.168.100.168
nc -vz 192.168.100.168 21
nc -vz 192.168.100.168 22
curl -I http://192.168.100.168/

# Ejemplo de salida de alertas
11/06-12:34:56.789012  [**] [1:1000001:1] ALERT ICMP to monitored host [**] [Priority: 0] {ICMP} 192.168.1.50 -> 192.168.100.168
11/06-12:35:02.123456  [**] [1:1000002:1] ALERT TCP to port 21 (FTP) [**] [Priority: 0] {TCP} 192.168.1.50:12345 -> 192.168.100.168:21
11/06-12:35:10.987654  [**] [1:1000003:1] ALERT TCP to port 22 (SSH) [**] [Priority: 0] {TCP} 192.168.1.50:54321 -> 192.168.100.168:22
11/06-12:35:20.000111  [**] [1:1000004:1] ALERT TCP to port 80 (HTTP) [**] [Priority: 0] {TCP} 192.168.1.50:33333 -> 192.168.100.168:80

#Por si algo falla
- Revisar rutas y variables si snort -T muestra errores.
- Ejecutar sudo ldconfig si faltan .so.
- Verificar que HOME_NET sea correcto.
- Asegurar permisos de /var/log/snort.

********************Snort Opcion 2 Instalacion********************
#Instalar las herramientas basicas para manejar repositorios
dnf install -y yum-utils device-mapper-persistent-data lvm2

Instalar los plugins para dnf
 sudo dnf -y install dnf-plugins-core
sudo dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

Instalar Docker Engine
sudo dnf install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin


#Iniciar Docker y habilitarlo
systemctl start docker
systemctl enable docker

#Crear la carpeta de snort
mkdir /root/snort-proyect
cd /root/snort-proyect


#Crear la carpeta de DockerFile
cat <<EOF > Dockerfile
FROM ubuntu:latest
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y snort tcpdump iproute2 net-tools && apt-get clean
RUN mkdir -p /var/log/snort
CMD ["/bin/bash"]
EOF

#Construir la imagen de ubuntu para Snort
docker build -t snort-ubuntu .

#Ejecutar lo siguiente en el docker
docker run -it --rm \
  --net=host \
  --cap-add=NET_ADMIN \
  --cap-add=NET_RAW \
  --name snort-listener \
  snort-ubuntu

#Ahora dentro de la terminar lanzar Snort (Ojo en 'ens192', usaras el nombre de tu interfaz de red), la puedes ver con ip addr
snort -i ens192 -vDE 'port 21 or port 22 or port 80'

---------------------------
Errores a comenter
---------------------------
#Si saliste con Exit del contenedor usar

1. Asegurarme que no hay uno viejo corriendo con el mismo nombre
docker rm -f snort-listener

2. Lanzar contenedor persistente
docker run -dt --restart=always \
  --net=host \
  --cap-add=NET_ADMIN \
  --cap-add=NET_RAW \
  --name snort-listener \
  snort-ubuntu

3.Para entrar al contenedor cuando quieras
docker exec -it snort-listener bash


Comandos usados practica 4

============================================

sudo dnf install google-authenticator -y

Mandar el qr a authenticator

sudo nano /etc/pam.d/sshd
auth required pam_google_authenticator.so 
---------Agregar lo siguiente


auth required pam_google_authenticator.so no_strict_owner (agregar )
auth required pam_unix.so (agregar)
auth substack password-auth
auth include postlogin
account include password-auth (agregar)

Configurar ssh para solicitar 2Fa
sudo nano /etc/ssh/sshd_config

ChallengeResponseAuthentication yes
UsePAM yes

Luego salir y dar permisos a google 

Dar permisos a Google
sudo chown server:server /home/Server/.google_authenticator
sudo chmod 400 /home/server/.google_authenticator





